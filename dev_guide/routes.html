<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Finding optimal routes - Navigating 18xx: calculating optimal routes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../18xx_introduction.html"><strong aria-hidden="true">1.</strong> 18xx introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../motivation.html"><strong aria-hidden="true">1.1.</strong> Motivation</a></li><li class="chapter-item expanded "><a href="../problem.html"><strong aria-hidden="true">1.2.</strong> The problem</a></li></ol></li><li class="chapter-item expanded "><a href="../user_guide/index.html"><strong aria-hidden="true">2.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user_guide/modal.html"><strong aria-hidden="true">2.1.</strong> Modal interface</a></li><li class="chapter-item expanded "><a href="../user_guide/global.html"><strong aria-hidden="true">2.2.</strong> Global keys</a></li><li class="chapter-item expanded "><a href="../user_guide/default.html"><strong aria-hidden="true">2.3.</strong> Default mode</a></li><li class="chapter-item expanded "><a href="../user_guide/tile.html"><strong aria-hidden="true">2.4.</strong> Placing and upgrading tiles</a></li><li class="chapter-item expanded "><a href="../user_guide/tokens.html"><strong aria-hidden="true">2.5.</strong> Placing and removing tokens</a></li><li class="chapter-item expanded "><a href="../user_guide/routes.html"><strong aria-hidden="true">2.6.</strong> Selecting optimal routes</a></li><li class="chapter-item expanded "><a href="../user_guide/example.html"><strong aria-hidden="true">2.7.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../dev_guide/index.html"><strong aria-hidden="true">3.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev_guide/overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../dev_guide/crates.html"><strong aria-hidden="true">3.2.</strong> Crates</a></li><li class="chapter-item expanded "><a href="../dev_guide/features.html"><strong aria-hidden="true">3.3.</strong> Features</a></li><li class="chapter-item expanded "><a href="../dev_guide/testing.html"><strong aria-hidden="true">3.4.</strong> Testing</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Cairo and drawing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Hex geometry and styling</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.7.</strong> Tile elements</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.8.</strong> Tile catalogue</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.9.</strong> Connectivity</div></li><li class="chapter-item expanded "><a href="../dev_guide/tokens.html"><strong aria-hidden="true">3.10.</strong> Tokens</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.11.</strong> Maps</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.12.</strong> Trains</div></li><li class="chapter-item expanded "><a href="../dev_guide/routes.html" class="active"><strong aria-hidden="true">3.13.</strong> Finding optimal routes</a></li><li class="chapter-item expanded "><a href="../dev_guide/performance.html"><strong aria-hidden="true">3.14.</strong> Performance</a></li><li class="chapter-item expanded "><a href="../dev_guide/profiling.html"><strong aria-hidden="true">3.15.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../dev_guide/determinism.html"><strong aria-hidden="true">3.16.</strong> Determinism</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.17.</strong> 18xx games</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.18.</strong> (De)serialisation</div></li><li class="chapter-item expanded "><a href="../dev_guide/rusty_train.html"><strong aria-hidden="true">3.19.</strong> GTK user interface</a></li></ol></li><li class="chapter-item expanded "><a href="../todo/index.html"><strong aria-hidden="true">4.</strong> To-do list</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../todo/documentation.html"><strong aria-hidden="true">4.1.</strong> Documentation</a></li><li class="chapter-item expanded "><a href="../todo/implementation.html"><strong aria-hidden="true">4.2.</strong> Implementation</a></li><li class="chapter-item expanded "><a href="../todo/features.html"><strong aria-hidden="true">4.3.</strong> Planned features</a></li><li class="chapter-item expanded "><a href="../todo/rust.html"><strong aria-hidden="true">4.4.</strong> Rust and Cargo</a></li><li class="chapter-item expanded "><a href="../todo/miscellaneous.html"><strong aria-hidden="true">4.5.</strong> Miscellaneous</a></li></ol></li><li class="chapter-item expanded "><a href="../about.html"><strong aria-hidden="true">5.</strong> About this book</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> References</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Navigating 18xx: calculating optimal routes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="identifying-optimal-routes"><a class="header" href="#identifying-optimal-routes">Identifying optimal routes</a></h1>
<p><strong>TODO:</strong> define the terms “path” and “route”.</p>
<p>We divide the process of identifying the optimal routes for a company to
operate into the following steps:</p>
<ol>
<li>
<p>Identify all routes available to the company;</p>
<ul>
<li>
<p>Constructing routes from each placed token.</p>
<ul>
<li>
<p>Paths as a sequence of <code>n18tile::Connection</code> values: <code>Track</code>, <code>Dit</code>,
<code>City</code>, <code>Face</code>.</p>
</li>
<li>
<p>The need to represent all of the track segments, in addition to mere
connectivity between dits and cities.</p>
</li>
<li>
<p>Use of <code>Face</code> and <code>n18map::Map::adjacent_face</code> so that we can divide
connectivity into two concerns: within-tile connectivity as provided by
<code>n18tile::Tile::connections</code>, and between-tile connectivity as provided
by <code>Map</code>.</p>
</li>
</ul>
</li>
<li>
<p>Joining routes together to form new routes.</p>
</li>
<li>
<p>Constraints on, e.g., the number of stops.</p>
</li>
<li>
<p>Can be extended to consider hex trains.</p>
</li>
<li>
<p>“Flood” trains
(<a href="https://boardgamegeek.com/listitem/7326833?commentid=9566272#comment9566272">description</a>)
can also be handled, although this requires a depth-first search that
records cities and dits, rather than paths.
Pick one placed station and sum every revenue centre that can be reached
with no path limit and the ability to reuse track segments.</p>
</li>
</ul>
</li>
<li>
<p>Identify all valid combinations of available routes;</p>
<ul>
<li>No track segments in common.</li>
</ul>
</li>
<li>
<p>Identify all valid pairings of trains to routes; and</p>
<ul>
<li>Number of stops, number of hexes, etc.</li>
</ul>
</li>
<li>
<p>Identify the optimal pairing of trains to routes.</p>
<ul>
<li>
<p>Express trains: where to stop?</p>
</li>
<li>
<p>Route bonuses.</p>
</li>
</ul>
</li>
</ol>
<p>We now describe each of these steps in turn.</p>
<p><strong>TODO:</strong> include diagrams to illustrate each step.
Show, e.g.,:</p>
<ul>
<li>
<p>Multiple (conflicting and non-conflicting) routes starting from a single
token;</p>
</li>
<li>
<p>Joining paths;</p>
</li>
<li>
<p>Path combinations;</p>
</li>
<li>
<p>Multiple routes along the same path due to different skips/stops.</p>
</li>
<li>
<p>Here is an example where the optimal routes for a pair of trains involves
sub-optimal routes for each train:</p>
<table><thead><tr><th align="center">Map</th><th>Description</th></tr></thead><tbody>
<tr><td align="center"><img src="opt_r1.png" alt="" /></td><td>Four connected cities</td></tr>
<tr><td align="center"><img src="opt_r1_8.png" alt="" /></td><td>8-train: optimal revenue is $320</td></tr>
<tr><td align="center"><img src="opt_r1_2p2.png" alt="" /></td><td>2+2-train: optimal revenue is $400</td></tr>
<tr><td align="center"><img src="opt_r1_both.png" alt="" /></td><td>Both trains: optimal revenue is $590</td></tr>
</tbody></table>
</li>
</ul>
<h2 id="identifying-all-available-routes"><a class="header" href="#identifying-all-available-routes">Identifying all available routes</a></h2>
<p>We assume that all routes operated by a company must pass through a city that
contains one of the company’s token.</p>
<ol>
<li>
<p>We first define the route limits, such as maximum number of stops, if any.</p>
</li>
<li>
<p>We then loop over all of the company’s placed tokens and, for each placed
token, construct all valid paths that <strong>start at this token</strong>.</p>
</li>
<li>
<p>To allow for paths that <strong>pass through</strong> a placed token, we form new paths
by joining pairs of paths that both start at the same placed token, subject
to the following constraints:</p>
<ul>
<li>
<p>The two paths being joined do not have any conflicts (i.e., they don’t
have any elements in common except for the placed token); and</p>
</li>
<li>
<p>The combined path respects constraints on length, number of stops, etc.</p>
</li>
</ul>
</li>
<li>
<p>To avoid duplicating paths that pass through more than one of the company’s
placed tokens, we:</p>
<ul>
<li>
<p>Define an ordering on token spaces across the entire map, by representing
each token space as a <code>(HexAddress, usize)</code> tuple, where <code>HexAddress</code>
implements <code>Ord</code> and the <code>usize</code> element is the index of the token space
on its tile.</p>
</li>
<li>
<p>When constructing paths that start at a placed token, we stop searching
when another of the company’s placed tokens is reached <strong>and</strong> according
to the <code>(HexAddress, usize)</code> ordering this encountered token comes before
(i.e., is less than) the starting token.</p>
</li>
</ul>
<p>This ensures that any connection between two of the company’s placed tokens
is only explored in a single (arbitrary, but consistent) direction.</p>
<p>Note that this is sufficient to identify all valid paths.
Each valid path will reach (or pass through) at least one placed token and,
of these tokens, one will be the “minimum” token according to the
<code>(HexAddress, usize)</code> ordering.
This path will then be constructed by steps 2 and 3, above, when starting
from this “minimum” token.</p>
</li>
<li>
<p>If the company owns any trains that can skip over towns and/or cities, we
consider paths of arbitrary length, with the restriction that any train
that operates this route:</p>
<ul>
<li>
<p>Must stop at the first and last revenue centres; and</p>
</li>
<li>
<p>May skip over revenue centres in the middle of the route.</p>
</li>
</ul>
<p>Note that in this case, a single path represents <strong>multiple routes</strong> that
traverse the same path, but where the train stops at a different subset of
the available revenue centres.</p>
</li>
</ol>
<h2 id="identifying-all-valid-combinations-of-routes"><a class="header" href="#identifying-all-valid-combinations-of-routes">Identifying all valid combinations of routes</a></h2>
<p>We need to consider all \(k\)-combinations of routes where there is at least
one route, but no more routes than the number of trains owned by the company.
That is, for a company that owns \(T\) trains, we need to consider all
\(k\)-combinations for each \(k: 1 \le k \le T \).</p>
<p>We also want to ignore any combination of routes where any of the routes
conflict with each other (e.g., by using the same track segment).
Note that by exploring all valid <strong>combinations</strong>, we ignore the <strong>order</strong> in
which routes are combined.</p>
<p>This is implemented by <code>n18route::comb::CombinationsFilter</code>, which internally
iterates over all route combinations and skips over combinations where any of
the routes conflict with each other.</p>
<h2 id="identifying-all-valid-pairings-of-trains-to-routes"><a class="header" href="#identifying-all-valid-pairings-of-trains-to-routes">Identifying all valid pairings of trains to routes</a></h2>
<p>We assume that the revenue earned from operating a route only depends on the
<strong>train type</strong>.
For example, if a company owns two <code>2</code> trains we do not need to consider the
order in which they are paired with routes, because the results will be
identical.</p>
<p>But for a given combination of routes — in which the routes will
necessarily be listed in a specific order — the order in which we
allocate train types to these routes <strong>matters</strong>.
For example, if there are two routes that visit exactly two cities and the
company owns a <code>2</code> train <strong>and</strong> a <code>2+2</code> train, the net revenue will be higher
if the <code>2+2</code> train operates the route that earns the greatest revenue.</p>
<p>So for a given (ordered) combination of \(R\) routes we need to explore all
of the \(R\)-permutations of the company’s trains that are unique in their
ordering of <strong>train types</strong>.</p>
<p>This is implemented by <code>n18route::perm::KPermutationsFilter</code>, which internally
iterates over all train <em>k</em>-permutations and skips over permutations that
don’t change the ordering of train types.</p>
<h2 id="identifying-the-optimal-combination-of-routes"><a class="header" href="#identifying-the-optimal-combination-of-routes">Identifying the optimal combination of routes</a></h2>
<p>Once we have collected all of the possible paths for a company, we need to
find the allocation of company trains to routes that yields the greatest
revenue.
There are a number of complications to consider:</p>
<ol>
<li>
<p>For a given set of routes, the revenue may depend on how we allocate these
routes to the company’s trains.
For example, if there are two routes that visit exactly two cities and the
company owns a <code>2</code> train <strong>and</strong> a <code>2+2</code> train, the <code>2+2</code> train should run
on the route that earns the greatest revenue.</p>
</li>
<li>
<p>We need to consider operating fewer routes than the company has trains.</p>
</li>
<li>
<p>For express trains, we must consider routes of all possible lengths, and
determine the combination of visiting and skipping cities along each route
that earns the greatest revenue.</p>
<ul>
<li>
<p>So for an express train that can make up to <code>N</code> stops, it must stop at
the first and last stops on the path, and up to <code>N - 2</code> stops anywhere
else along the path.</p>
</li>
<li>
<p>Note that route bonuses may affect which of the <code>N - 2</code> stops earn the
most revenue, so we need to evaluate <strong>every combination</strong> of stopping
at, or skipping over, each revenue centre (except for the first and last
centres, where the train must stop).</p>
</li>
</ul>
</li>
<li>
<p>Routes may earn bonus revenue from a variety of sources, such as:</p>
<ul>
<li>
<p>By owning private companies that provide bonus revenue when visiting a
specific location.</p>
</li>
<li>
<p>By visiting a specific combination of cities.
For example, in 1867 the city of Timmins normally earns $40, but if the
route also includes at least one of Toronto, Montréal, or Québec, its
revenue is doubled ($80).</p>
</li>
</ul>
<p>These bonuses are game-specific and context-dependent.
The supported bonus types are defined by the <code>n18route::bonus::Bonus</code> enum.</p>
</li>
</ol>
<p><strong>TODO:</strong> haven’t described all steps of the algorithm ...</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev_guide/tokens.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../dev_guide/performance.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev_guide/tokens.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../dev_guide/performance.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
