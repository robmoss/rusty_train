<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation - Navigating 18xx: calculating optimal routes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../18xx_introduction.html"><strong aria-hidden="true">1.</strong> 18xx introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../motivation.html"><strong aria-hidden="true">1.1.</strong> Motivation</a></li><li class="chapter-item expanded "><a href="../problem.html"><strong aria-hidden="true">1.2.</strong> The problem</a></li></ol></li><li class="chapter-item expanded "><a href="../user_guide/index.html"><strong aria-hidden="true">2.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user_guide/modal.html"><strong aria-hidden="true">2.1.</strong> Modal interface</a></li><li class="chapter-item expanded "><a href="../user_guide/global.html"><strong aria-hidden="true">2.2.</strong> Global keys</a></li><li class="chapter-item expanded "><a href="../user_guide/default.html"><strong aria-hidden="true">2.3.</strong> Default mode</a></li><li class="chapter-item expanded "><a href="../user_guide/tile.html"><strong aria-hidden="true">2.4.</strong> Placing and upgrading tiles</a></li><li class="chapter-item expanded "><a href="../user_guide/tokens.html"><strong aria-hidden="true">2.5.</strong> Placing and removing tokens</a></li><li class="chapter-item expanded "><a href="../user_guide/routes.html"><strong aria-hidden="true">2.6.</strong> Selecting optimal routes</a></li><li class="chapter-item expanded "><a href="../user_guide/example.html"><strong aria-hidden="true">2.7.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="../dev_guide/index.html"><strong aria-hidden="true">3.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev_guide/overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../dev_guide/crates.html"><strong aria-hidden="true">3.2.</strong> Crates</a></li><li class="chapter-item expanded "><a href="../dev_guide/features.html"><strong aria-hidden="true">3.3.</strong> Features</a></li><li class="chapter-item expanded "><a href="../dev_guide/testing.html"><strong aria-hidden="true">3.4.</strong> Testing</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Cairo and drawing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Hex geometry and styling</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.7.</strong> Tile elements</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.8.</strong> Tile catalogue</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.9.</strong> Connectivity</div></li><li class="chapter-item expanded "><a href="../dev_guide/tokens.html"><strong aria-hidden="true">3.10.</strong> Tokens</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.11.</strong> Maps</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.12.</strong> Trains</div></li><li class="chapter-item expanded "><a href="../dev_guide/routes.html"><strong aria-hidden="true">3.13.</strong> Finding optimal routes</a></li><li class="chapter-item expanded "><a href="../dev_guide/performance.html"><strong aria-hidden="true">3.14.</strong> Performance</a></li><li class="chapter-item expanded "><a href="../dev_guide/profiling.html"><strong aria-hidden="true">3.15.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../dev_guide/determinism.html"><strong aria-hidden="true">3.16.</strong> Determinism</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.17.</strong> 18xx games</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.18.</strong> (De)serialisation</div></li><li class="chapter-item expanded "><a href="../dev_guide/rusty_train.html"><strong aria-hidden="true">3.19.</strong> GTK user interface</a></li></ol></li><li class="chapter-item expanded "><a href="../todo/index.html"><strong aria-hidden="true">4.</strong> To-do list</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../todo/documentation.html"><strong aria-hidden="true">4.1.</strong> Documentation</a></li><li class="chapter-item expanded "><a href="../todo/implementation.html" class="active"><strong aria-hidden="true">4.2.</strong> Implementation</a></li><li class="chapter-item expanded "><a href="../todo/features.html"><strong aria-hidden="true">4.3.</strong> Planned features</a></li><li class="chapter-item expanded "><a href="../todo/rust.html"><strong aria-hidden="true">4.4.</strong> Rust and Cargo</a></li><li class="chapter-item expanded "><a href="../todo/miscellaneous.html"><strong aria-hidden="true">4.5.</strong> Miscellaneous</a></li></ol></li><li class="chapter-item expanded "><a href="../about.html"><strong aria-hidden="true">5.</strong> About this book</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> References</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Navigating 18xx: calculating optimal routes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementation-details"><a class="header" href="#implementation-details">Implementation details</a></h1>
<p>This page collects implementation details that should be added, changed, removed, or fixed.</p>
<h2 id="invalid-route-finding-options"><a class="header" href="#invalid-route-finding-options">Invalid route-finding options</a></h2>
<p>The route-finding algorithm assumes that routes can be constructed from one or more paths, where each path starts at a token T1 and never proceeds past a token T2 where T2 &gt; T1, and we join pairs of paths that both start from the same token T and have no conflicts.</p>
<p>The path-building algorithm and route-finding algorithm both assume that a single path cannot pass through the same revenue centre more than once.
Note that the path-building algorithm stops whenever it encounters any kind of connection (hex face, track segment, revenue centre) that it has already visited.</p>
<p>The search criteria (<code>n18route::search::Criteria</code>) cannot allow <code>conflict_rule</code> to be <code>ConflictRule::TrackOnly</code> (i.e., no track segment in common), because this would mean that a single route could visit the same revenue centre multiple times, if there are sufficient track connections.</p>
<ul>
<li>
<p>So the implementation should panic, or return an <code>Error</code> value.</p>
</li>
<li>
<p>Are there any games where this is a relevant concern?
Note that this does not apply to “Flood” trains, which earn revenue from every revenue centre that can be reached from a single token (i.e., only requires a search from each matching token, and selecting the token that earns the most revenue).</p>
</li>
</ul>
<p>See the <code>n18route::search</code> and <code>n18route::train</code> modules for the implementation.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h2>
<p>The current implementation generally avoids returning <code>Result&lt;T,E&gt;</code> values and instead panics when an error is encountered.
Many of these panics are triggered by Cairo errors, such as failing to create a surface or context, or failing to draw on a surface, for which there is no obvious mitigation and panicking is an acceptable solution.</p>
<ul>
<li>But other panics should be removed and <code>Result&lt;T,E&gt;</code> values should be returned in their place.</li>
</ul>
<p>Potential panics can be located with the following command:</p>
<pre><code class="language-sh">grep --color=always -E '(\.unwrap|\.expect|panic!\()' -r crates/ tests/ examples/ src/
</code></pre>
<p>See <a href="https://www.lpalmieri.com/posts/error-handling-rust/">this article about error handling in Rust</a>, which frames error handling in terms of their <strong>purpose</strong> and <strong>location</strong>.</p>
<p>Relevant crates include <a href="https://github.com/dtolnay/anyhow">anyhow</a>, <a href="https://github.com/yaahc/eyre">eyre</a>, and <a href="https://github.com/dtolnay/thiserror">thiserror</a>.</p>
<p>Also see <a href="https://redd.it/pegi1d">this /r/rust discussion</a> about disallowing specific methods with clippy.</p>
<h2 id="builder-patterns"><a class="header" href="#builder-patterns">Builder patterns</a></h2>
<p>Some of the more complex data structures would benefit from a <strong>builder</strong> to simplify their construction.
The preferred option is a <a href="https://rust-lang.github.io/api-guidelines/type-safety.html#builders-enable-construction-of-complex-values-c-builder">non-consuming builder</a> whose methods accept <code>&amp;mut self</code> values and return <code>&amp;mut Self</code> values.</p>
<p>I have implemented builders for some types (some consuming, some non-consuming), and have defined builder-like methods for other types (e.g., <code>n18hex::theme::Text</code>).</p>
<ul>
<li>
<p>There are likely other types for which a builder would be useful.</p>
</li>
<li>
<p>Consuming builders should probably be converted into non-consuming builders.</p>
</li>
</ul>
<h2 id="remove-n18io-crate"><a class="header" href="#remove-n18io-crate">Remove n18io crate</a></h2>
<p>It is possible to use <a href="https://rust-lang.github.io/api-guidelines/interoperability.html#data-structures-implement-serdes-serialize-deserialize-c-serde">features to enable/disable (de)serialisation</a>, which would remove the need for the <code>n18io</code> crate.</p>
<p>To include/exclude both serde and serde_json we need to define a single feature that enables/disables both crates:</p>
<pre><code class="language-toml">[features]
load_save = [&quot;serde&quot;, &quot;serde_json&quot;]
</code></pre>
<p>Note that optional dependencies <a href="https://doc.rust-lang.org/cargo/reference/features.html">implicitly define</a> a feature of the same name as the dependency, and so explicit features cannot use the same name as a dependency.</p>
<ul>
<li>The <code>namespaced-features</code> feature would allow us to define a <code>serde</code> feature than enables both crates; see the <a href="https://github.com/rust-lang/rfcs/pull/3143">RFC</a> and <a href="https://github.com/rust-lang/cargo/issues/5565">tracking issue</a> for details.</li>
</ul>
<p>But note that features and workspaces <strong>are not easily combined</strong>; see these issues — <a href="https://github.com/rust-lang/cargo/issues/4463">1</a>, <a href="https://github.com/rust-lang/cargo/issues/5015">2</a>, <a href="https://github.com/rust-lang/cargo/issues/5251">3</a>, <a href="https://github.com/rust-lang/cargo/issues/9094">4</a> — for some perspective.</p>
<ul>
<li>
<p>It would appear that each crate would need to define this <code>load_save</code> feature, and for the <code>navig18xx</code> crate this feature would enable <code>crate-name/load_save</code> for each of these crates.</p>
</li>
<li>
<p>The <code>navig18xx</code> crate should have no features enabled by default (i.e., not <code>load_save</code> or <code>ui</code>).
These features can be enabled in the root <code>Cargo.toml</code> file so that they’re available to the <code>rusty_train</code> binary.</p>
</li>
</ul>
<h2 id="use-a-single-index-for-token-spaces"><a class="header" href="#use-a-single-index-for-token-spaces">Use a single index for token spaces</a></h2>
<p>Token spaces are currently indexed by revenue centre and by the token space number in that revenue centre.
Using a flat index <code>0..N</code> instead (or in addition) could make other parts of the code simpler and easier to understand.
For example, this would make it much simpler to show all placed tokens on replacement tiles.</p>
<h2 id="separate-combinations-and-permutations-crates"><a class="header" href="#separate-combinations-and-permutations-crates">Separate combinations and permutations crates</a></h2>
<ul>
<li>Consider splitting out the <code>n18route::comb</code> and <code>n18route::perm</code> modules into separate crates (e.g., <code>n18comb</code> and <code>n18perm</code>).</li>
</ul>
<h2 id="export-items-in-crate-root"><a class="header" href="#export-items-in-crate-root">Export items in crate root</a></h2>
<p>Maybe we should (re)export every public type or function from the crate root.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../todo/documentation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../todo/features.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../todo/documentation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../todo/features.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
